generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model School {
  id            String              @id @default(cuid())
  name          String
  address       String?
  contact       String?
  coordinatorId String?             @unique
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  logoUrl       String?
  slug          String              @unique
  grades        Grade[]
  bookLicenses  SchoolBookLicense[]
  coordinator   User?               @relation("SchoolCoordinator", fields: [coordinatorId], references: [id])
  users         User[]              @relation("SchoolUsers")

  @@index([coordinatorId])
  @@index([slug])
  @@map("schools")
}

model User {
  id                String              @id @default(cuid())
  email             String              @unique
  name              String?
  roles             UserRole[]
  status            UserStatus          @default(INVITED)
  schoolId          String?
  createdBy         String?
  lastLogin         DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  deletedAt         DateTime?
  annotations       Annotation[]
  assignedAccesses  BookAccess[]        @relation("AssignedByUser")
  bookAccesses      BookAccess[]        @relation("UserBookAccess")
  bookAssignments   BookAssignment[]    @relation("BookAssignments")
  bookReviews       BookReview[]        @relation("UserBookReviews")
  reportedComments  CommentReport[]     @relation("ReportedComments")
  reviewedReports   CommentReport[]     @relation("ReviewedReports")
  teacherGroups     Group[]             @relation("TeacherGroups")
  guideComments     GuideComment[]      @relation("UserGuideComments")
  guideCommentLikes GuideCommentLike[]  @relation("UserGuideCommentLikes")
  notifications     Notification[]
  assignedLicenses  SchoolBookLicense[] @relation("SchoolLicenseAssigner")
  coordinatedSchool School?             @relation("SchoolCoordinator")
  sessions          Session[]
  studentGroups     UserGroup[]         @relation("StudentGroups")
  school            School?             @relation("SchoolUsers", fields: [schoolId], references: [id])

  @@index([email])
  @@index([schoolId])
  @@index([status])
  @@index([deletedAt])
  @@map("users")
}

model Grade {
  id        String   @id @default(cuid())
  name      String
  level     String?
  schoolId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  books     Book[]
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  groups    Group[]

  @@index([schoolId])
  @@map("grades")
}

model Group {
  id        String      @id @default(cuid())
  name      String
  gradeId   String
  teacherId String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  grade     Grade       @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  teacher   User?       @relation("TeacherGroups", fields: [teacherId], references: [id], onDelete: Cascade)
  students  UserGroup[] @relation("GroupStudents")

  @@index([gradeId])
  @@index([teacherId])
  @@map("groups")
}

model UserGroup {
  id        String   @id @default(cuid())
  userId    String
  groupId   String
  createdAt DateTime @default(now())
  group     Group    @relation("GroupStudents", fields: [groupId], references: [id], onDelete: Cascade)
  user      User     @relation("StudentGroups", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, groupId])
  @@index([userId])
  @@index([groupId])
  @@map("user_groups")
}

model Book {
  id             String              @id @default(cuid())
  sanityId       String              @unique
  title          String
  gradeId        String?
  subject        String?
  pdfUrl         String
  isDownloadable Boolean             @default(false)
  version        String              @default("1.0")
  accessType     String              @default("restricted")
  targetAudience String?
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  annotations    Annotation[]
  bookAccesses   BookAccess[]
  grade          Grade?              @relation(fields: [gradeId], references: [id])
  schoolLicenses SchoolBookLicense[]

  @@index([sanityId])
  @@index([gradeId])
  @@index([isActive])
  @@map("books")
}

model BookAccess {
  id         String       @id @default(cuid())
  userId     String
  bookId     String
  assignedBy String
  startDate  DateTime
  endDate    DateTime
  isActive   Boolean      @default(true)
  status     AccessStatus @default(ACTIVE)
  groupId    String?
  gradeId    String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  assigner   User         @relation("AssignedByUser", fields: [assignedBy], references: [id], onDelete: Cascade)
  book       Book         @relation(fields: [bookId], references: [id], onDelete: Cascade)
  user       User         @relation("UserBookAccess", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId, startDate])
  @@index([userId])
  @@index([bookId])
  @@index([status])
  @@index([endDate])
  @@index([groupId])
  @@index([gradeId])
  @@map("book_accesses")
}

model SchoolBookLicense {
  id            String   @id @default(cuid())
  schoolId      String
  bookId        String
  totalLicenses Int
  usedLicenses  Int      @default(0)
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean  @default(true)
  assignedBy    String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  assigner      User     @relation("SchoolLicenseAssigner", fields: [assignedBy], references: [id])
  book          Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, bookId])
  @@index([schoolId])
  @@index([bookId])
  @@index([isActive])
  @@map("school_book_licenses")
}

model Annotation {
  id         String               @id @default(cuid())
  userId     String
  bookId     String
  page       Int
  type       String
  content    String?
  color      String?
  position   Json?
  visibility AnnotationVisibility @default(PRIVATE)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  book       Book                 @relation(fields: [bookId], references: [id], onDelete: Cascade)
  user       User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bookId])
  @@index([page])
  @@map("annotations")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  refreshToken String?  @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  lastActivity DateTime @default(now())
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model AdditionalResource {
  id          String   @id @default(cuid())
  title       String
  description String?
  fileUrl     String
  fileType    String
  targetRole  String   @default("teacher")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([targetRole])
  @@index([isActive])
  @@map("additional_resources")
}

model BookAssignment {
  id             String    @id @default(cuid())
  bookSanityId   String
  assignedToType String
  assignedToId   String
  assignedBy     String
  startDate      DateTime  @default(now())
  endDate        DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  assigner       User      @relation("BookAssignments", fields: [assignedBy], references: [id], onDelete: Cascade)

  @@index([bookSanityId])
  @@index([assignedToType])
  @@index([assignedToId])
  @@index([assignedBy])
  @@index([isActive])
  @@map("book_assignments")
}

model GuideComment {
  id            String             @id @default(cuid())
  guideSanityId String
  userId        String
  content       String
  imageUrls     String[]
  parentId      String?
  isEdited      Boolean            @default(false)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  entrySanityId String?
  likes         GuideCommentLike[]
  reports       CommentReport[]
  parent        GuideComment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies       GuideComment[]     @relation("CommentReplies")
  user          User               @relation("UserGuideComments", fields: [userId], references: [id], onDelete: Cascade)

  @@index([guideSanityId])
  @@index([entrySanityId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("guide_comments")
}

model GuideCommentLike {
  id        String       @id @default(cuid())
  commentId String
  userId    String
  createdAt DateTime     @default(now())
  comment   GuideComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User         @relation("UserGuideCommentLikes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId], name: "commentId_userId")
  @@index([commentId])
  @@index([userId])
  @@map("guide_comment_likes")
}

model BookReview {
  id                 String   @id @default(cuid())
  bookSanityId       String
  userId             String
  rating             Int
  comment            String?
  isVerifiedPurchase Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  user               User     @relation("UserBookReviews", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([bookSanityId, userId])
  @@index([bookSanityId])
  @@index([userId])
  @@index([rating])
  @@map("book_reviews")
}

model CommentReport {
  id          String       @id @default(cuid())
  commentId   String
  reportedBy  String
  reason      String
  description String?
  status      String       @default("pending")
  reviewedBy  String?
  reviewedAt  DateTime?
  createdAt   DateTime     @default(now())
  comment     GuideComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  reporter    User         @relation("ReportedComments", fields: [reportedBy], references: [id], onDelete: Cascade)
  reviewer    User?        @relation("ReviewedReports", fields: [reviewedBy], references: [id])

  @@index([commentId])
  @@index([reportedBy])
  @@index([status])
  @@map("comment_reports")
}

enum UserRole {
  ADMIN
  COORDINATOR
  TEACHER
  STUDENT
  PUBLIC
}

enum UserStatus {
  INVITED
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AccessStatus {
  INVITED
  ACTIVE
  EXPIRED
  SUSPENDED
  REVOKED
}

enum AnnotationVisibility {
  PRIVATE
  TEACHER
  COORDINATOR
}

enum NotificationType {
  ACCESS_GRANTED
  ACCESS_EXPIRING
  ACCESS_EXPIRED
  STUDENT_ADDED
  NEW_RESOURCE
  COMMENT_REPLY
  COMMENT_LIKE
  SUBSCRIPTION_EXPIRING
  SUBSCRIPTION_EXPIRED
  BOOK_ASSIGNED
  SYSTEM
}
